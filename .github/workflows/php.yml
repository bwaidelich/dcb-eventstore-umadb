name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:

    strategy:
      matrix:
        php-versions: [ '8.4' ]

    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential g++ libtool autoconf automake pkg-config protobuf-compiler libclang-dev

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Setup PHP with extensions
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-versions }}
        tools: pie

    - name: Ensure pie is available
      run: |
        if ! command -v pie &> /dev/null; then
          echo "pie not found, installing manually..."
          curl -L https://github.com/php/pie/releases/latest/download/pie.phar -o pie
          chmod +x pie
          sudo mv pie /usr/local/bin/pie
        fi
        pie --version

    - name: Install UmaDB PHP extension
      run: |
        # Ensure Rust/Cargo is in PATH
        source $HOME/.cargo/env
        cargo --version

        # Clone and build the extension manually
        git clone https://github.com/bwaidelich/umadb-php.git /tmp/umadb-php
        cd /tmp/umadb-php

        # Build using Cargo
        cargo build --release

        # Find the compiled extension
        if [ -f "target/release/libumadb.so" ]; then
          EXT_FILE="target/release/libumadb.so"
        elif [ -f "target/release/libumadb.dylib" ]; then
          EXT_FILE="target/release/libumadb.dylib"
        else
          echo "Extension file not found!"
          ls -la target/release/
          exit 1
        fi

        # Install the extension
        PHP_EXT_DIR=$(php-config --extension-dir)
        sudo cp "$EXT_FILE" "$PHP_EXT_DIR/umadb.so"

        # Enable the extension
        echo "extension=umadb.so" | sudo tee -a $(php --ini | grep "Loaded Configuration File" | awk '{print $4}')

    - name: Verify UmaDB extension
      run: php -m | grep umadb

    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: Run PHPStan tests
      run: composer run-script test:phpstan

    - name: Run Code Sniffer tests
      run: composer run-script test:cs

    - name: Run integration tests
      run: composer run-script test:integration